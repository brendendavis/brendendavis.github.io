<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>D&D Character Manager</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
  <script>
    (function() {
      const params = new URLSearchParams(window.location.search);
      const startInPlayerView = params.get('view') === 'player';
      window.CAMPAIGN_ID = params.get('campaign') || 'default';
      window.PROFILE_ID = params.get('profile') || (startInPlayerView ? 'player' : 'dm');
      window.IS_EMBEDDED_VIEW = params.get('embedded') === 'true';
      function setGlobalPlayerView(isPlayer) {
        const enabled = !!isPlayer;
        window.IS_PLAYER_VIEW = enabled;
        document.documentElement.classList.toggle('player-view', enabled);
        if (typeof window.setMappyPlayerViewMode === 'function') {
          window.setMappyPlayerViewMode(enabled);
        }
      }
      window.setGlobalPlayerView = setGlobalPlayerView;
      setGlobalPlayerView(startInPlayerView);
      if (window.IS_EMBEDDED_VIEW) {
        document.documentElement.classList.add('embedded-view');
      }
    })();
  </script>
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <nav>
        <ul>
          <li><a href="#SAVE-LOAD">SAVE / LOAD</a></li> 
          <li><a href="#character-info">Character Info</a></li>
          <li><a href="#racial-details">Racial Details</a></li>
          <li><a href="#class-features">Class Features</a></li>
          <li><a href="#ability-scores">Ability Scores</a></li>
          <li><a href="#inspiration">Inspiration & Proficiency</a></li>
          <li><a href="#saving-throws">Saving Throws</a></li>
          <li><a href="#dice-roller">Dice Roller</a></li>
          <li><a href="#skills">Skills</a></li>
          <li><a href="#other-proficiencies">Other Proficiencies</a></li>
          <li><a href="#combat-stats">Combat Stats</a></li>
          <li><a href="#attacks-spellcasting">Attacks & Spellcasting</a></li>
          <li><a href="#spell-console">Spell Console</a></li>
          <li><a href="#equipment">Equipment</a></li>
          <li><a href="#feats">Feats</a></li>
          <li><a href="#personality-backstory">Personality & Bio</a></li>
          <li><a href="#mr-mappy">Mr. Mappy Map</a></li>
        </ul>
      </nav>
    </aside>
    <main class="main-content">
      <div class="profile-tabs" role="tablist">
        <button type="button" class="profile-tab active" data-profile-id="dm" data-role="dm">Dungeon Master</button>
        <button type="button" class="profile-tab" data-profile-id="player-1" data-role="player">Player 1</button>
        <button type="button" class="profile-tab" data-profile-id="player-2" data-role="player">Player 2</button>
        <button type="button" class="profile-tab add-tab" id="addPlayerTab">+ Add Player</button>
      </div>
      <div id="dmWorkspace">
      <header class="hero-banner">
        <div class="hero-text">
          <p class="hero-eyebrow">Campaign Command Center</p>
          <h1>D&D Character Manager</h1>
          <p class="hero-subtitle">Track lore, combat stats, spells, and maps from a single cinematic dashboard.</p>
        </div>
        <div class="hero-actions character-management" id="SAVE-LOAD">
          <button onclick="saveCharacter()">Save Character</button>
          <select id="loadCharacterSelect" onchange="loadCharacter(this.value)">
            <option value="">-- Load Character --</option>
          </select>
          <button onclick="populateCharacterList()">Refresh Character List</button>
          <button onclick="exportCharacterSheet()">Export Character Sheet</button>
        </div>
        <div class="hero-glance">
          <div class="glance-card">
            <p>Character</p>
            <strong id="glanceName">Unnamed Hero</strong>
          </div>
          <div class="glance-card">
            <p>Level</p>
            <strong id="glanceLevel">1</strong>
          </div>
          <div class="glance-card">
            <p>Hit Points</p>
            <strong id="glanceHP">0</strong>
          </div>
          <div class="glance-card">
            <p>Inspiration</p>
            <strong id="glanceInspiration">0</strong>
          </div>
        </div>
      </header>
      <button type="button" class="sidebar-toggle dm-only" id="sidebarToggle">Menu &amp; Jump Links</button>
       <form id="characterForm"> 
        <div class="main-column">
        <div class="section-grid">
        <section id="character-info">
          <fieldset>
            <legend>Character Info</legend>
            <label for="characterName">Name:</label>
            <input type="text" id="characterName" placeholder="Enter character name">
            <label for="playerName">Player Name:</label>
            <input type="text" id="playerName" placeholder="Enter player name">
            
            <label for="characterClass">Class:</label>
            <select id="characterClass" onchange="updateClass()">
              <option value="">-- Select Class --</option>
              <option value="Barbarian">Barbarian</option>
              <option value="Bard">Bard</option>
              <option value="Cleric">Cleric</option>
              <option value="Druid">Druid</option>
              <option value="Fighter">Fighter</option>
              <option value="Monk">Monk</option>
              <option value="Paladin">Paladin</option>
              <option value="Ranger">Ranger</option>
              <option value="Rogue">Rogue</option>
              <option value="Sorcerer">Sorcerer</option>
              <option value="Warlock">Warlock</option>
              <option value="Wizard">Wizard</option>
            </select>
            <label for="characterSubclass">Subclass:</label>
            <select id="characterSubclass" style="display: none;"></select> <br>

            <label for="level">Level:</label>
              <input type="number" id="level" placeholder="1" min="1">

            <label for="race">Race:</label>
            <select id="race" onchange="updateRace()">
              <option value="Dragonborn">Dragonborn</option>
              <option value="Drow">Drow</option>
              <option value="Dwarf">Dwarf</option>
              <option value="Duergar">Duergar</option>
              <option value="Elf">Elf</option>
              <option value="Eladrin">Eladrin</option>
              <option value="Gnome">Gnome</option>
              <option value="Svirfneblin">Svirfneblin</option>
              <option value="Half-Elf">Half-Elf</option>
              <option value="Half-Orc">Half-Orc</option>
              <option value="Halfling">Halfling</option>
              <option value="Ghostwise Halfling">Ghostwise Halfling</option>
              <option value="Human">Human</option>
              <option value="Tiefling">Tiefling</option>
              <option value="Tiefling (Feral)">Tiefling (Feral)</option>
              <option value="Aasimar">Aasimar</option>
              <option value="Firbolg">Firbolg</option>
              <option value="Goliath">Goliath</option>
              <option value="Kenku">Kenku</option>
              <option value="Lizardfolk">Lizardfolk</option>
              <option value="Tabaxi">Tabaxi</option>
              <option value="Triton">Triton</option>
              <option value="Bugbear">Bugbear</option>
              <option value="Goblin">Goblin</option>
              <option value="Hobgoblin">Hobgoblin</option>
              <option value="Kobold">Kobold</option>
              <option value="Orc">Orc</option>
              <option value="Yuan-Ti Pureblood">Yuan-Ti Pureblood</option>
              <option value="Githyanki">Githyanki</option>
              <option value="Githzerai">Githzerai</option>
              <option value="Changeling">Changeling</option>
              <option value="Kalashtar">Kalashtar</option>
              <option value="Shifter">Shifter</option>
              <option value="Warforged">Warforged</option>
              <option value="Centaur">Centaur</option>
              <option value="Loxodon">Loxodon</option>
              <option value="Minotaur">Minotaur</option>
              <option value="Simic Hybrid">Simic Hybrid</option>
              <option value="Vedalken">Vedalken</option>
              <option value="Leonin">Leonin</option>
              <option value="Satyr">Satyr</option>
              <option value="Tortle">Tortle</option>
              <option value="Verdan">Verdan</option>
            </select>
            <label for="alignment">Alignment:</label>
            <select id="alignment">
              <option value="">-- Select Alignment --</option>
              <option value="Lawful Good">Lawful Good</option>
              <option value="Neutral Good">Neutral Good</option>
              <option value="Chaotic Good">Chaotic Good</option>
              <option value="Lawful Neutral">Lawful Neutral</option>
              <option value="True Neutral">True Neutral</option>
              <option value="Chaotic Neutral">Chaotic Neutral</option>
              <option value="Lawful Evil">Lawful Evil</option>
              <option value="Neutral Evil">Neutral Evil</option>
              <option value="Chaotic Evil">Chaotic Evil</option>
            </select>
            <label for="background">Background:</label>
            <select id="background">
              <option value="">-- Select Background --</option>
              <option value="Acolyte">Acolyte</option>
              <option value="Charlatan">Charlatan</option>
              <option value="Criminal">Criminal</option>
              <option value="Entertainer">Entertainer</option>
              <option value="Folk Hero">Folk Hero</option>
              <option value="Guild Artisan">Guild Artisan</option>
              <option value="Hermit">Hermit</option>
              <option value="Noble">Noble</option>
              <option value="Outlander">Outlander</option>
              <option value="Sage">Sage</option>
              <option value="Sailor">Sailor</option>
              <option value="Soldier">Soldier</option>
              <option value="Urchin">Urchin</option>
              <!-- Additional backgrounds from other sourcebooks -->
              <option value="City Watch">City Watch</option>
              <option value="Clan Crafter">Clan Crafter</option>
              <option value="Cloistered Scholar">Cloistered Scholar</option>
              <option value="Courtier">Courtier</option>
              <option value="Faction Agent">Faction Agent</option>
              <option value="Far Traveler">Far Traveler</option>
              <option value="Gladiator">Gladiator</option>
              <option value="Guild Merchant">Guild Merchant</option>
              <option value="Knight">Knight</option>
              <option value="Mercenary Veteran">Mercenary Veteran</option>
              <option value="Pirate">Pirate</option>
              <option value="Spy">Spy</option>
            </select>
            <label for="experience">Experience Points (XP):</label>
            <input type="number" id="experience" placeholder="0" min="0">
          </fieldset>
          <button type="button" onclick="createCharacterFromForm()">Update HP/Hit Dice</button> <br><br>

        </section>
        
        <section id="racial-details">
          <fieldset>
            <legend>Racial Details</legend>
            <div>
              <label for="subraceSelect" id="subraceLabel" style="display:none;">Subrace:</label>
              <select id="subraceSelect" style="display:none;" onchange="updateRace()"></select>
            </div>
            <div>
              <strong>Ability Score Bonuses:</strong>
              <span id="racialAbilityBonuses"></span>
            </div>
            <div>
              <strong>Speed:</strong>
              <span id="racialSpeed"></span>
            </div>
            <div>
              <strong>Languages:</strong>
              <span id="racialLanguages"></span>
            </div>
            <div>
              <strong>Traits:</strong>
              <span id="racialTraits"></span>
            </div>
            <div>
              <strong>Proficiencies:</strong>
              <span id="racialProficiencies"></span>
            </div>
          </fieldset>
        </section>
        </div>
        <div class="section-grid">
        <section id="class-features">
          <fieldset>
            <legend>Class Features & Actions</legend>
            <div id="classFeatureList"></div>
          </fieldset>
        </section>
        <section id="ability-scores">
          <fieldset>
            <legend>Ability Scores (Standard Array by Default)</legend>
            <label for="scoreMethod">Score Generation Method:</label>
            <select id="scoreMethod">
              <option value="Standard Array">Standard Array</option>
              <option value="Point Buy">Point Buy</option>
              <option value="Roll Dice">Roll Dice</option>
            </select>
            <button type="button" id="rollDiceButton">Roll Abilities</button>
            <div id="remainingPointsDisplay">Remaining Points: <span id="remainingPoints">27</span></div>
            
            <table>
              <tr>
                <th>Ability</th>
                <th>Base Score</th>
                <th>Racial Bonus</th>
                <th>Total Modifier</th>
              </tr>
              <tr>
                <td><label for="str">Strength (STR)</label></td>
                <td>
                  <input type="number" id="str" value="15" min="1" 
                         onchange="recalc(); updatePointBuyRemaining()" 
                         oninput="recalc(); updatePointBuyRemaining()">
                </td>
                <td><input type="text" id="strBonus" readonly></td>
                <td><input type="text" id="strMod" readonly></td>
              </tr>
              <tr>
                <td><label for="dex">Dexterity (DEX)</label></td>
                <td>
                  <input type="number" id="dex" value="14" min="1" 
                         onchange="recalc(); updatePointBuyRemaining()" 
                         oninput="recalc(); updatePointBuyRemaining()">
                </td>
                <td><input type="text" id="dexBonus" readonly></td>
                <td><input type="text" id="dexMod" readonly></td>
              </tr>
              <tr>
                <td><label for="con">Constitution (CON)</label></td>
                <td>
                  <input type="number" id="con" value="13" min="1" 
                         onchange="recalc(); updatePointBuyRemaining()" 
                         oninput="recalc(); updatePointBuyRemaining()">
                </td>
                <td><input type="text" id="conBonus" readonly></td>
                <td><input type="text" id="conMod" readonly></td>
              </tr>
              <tr>
                <td><label for="int">Intelligence (INT)</label></td>
                <td>
                  <input type="number" id="int" value="12" min="1" 
                         onchange="recalc(); updatePointBuyRemaining()" 
                         oninput="recalc(); updatePointBuyRemaining()">
                </td>
                <td><input type="text" id="intBonus" readonly></td>
                <td><input type="text" id="intMod" readonly></td>
              </tr>
              <tr>
                <td><label for="wis">Wisdom (WIS)</label></td>
                <td>
                  <input type="number" id="wis" value="10" min="1" 
                         onchange="recalc(); updatePointBuyRemaining()" 
                         oninput="recalc(); updatePointBuyRemaining()">
                </td>
                <td><input type="text" id="wisBonus" readonly></td>
                <td><input type="text" id="wisMod" readonly></td>
              </tr>
              <tr>
                <td><label for="cha">Charisma (CHA)</label></td>
                <td>
                  <input type="number" id="cha" value="8" min="1" 
                         onchange="recalc(); updatePointBuyRemaining()" 
                         oninput="recalc(); updatePointBuyRemaining()">
                </td>
                <td><input type="text" id="chaBonus" readonly></td>
                <td><input type="text" id="chaMod" readonly></td>
              </tr>
            </table>
          </fieldset>
        </section>
        </div>
        
        <!-- Inspiration & Proficiency Section -->
        <div class="section-grid">
        <section id="inspiration">
          <fieldset>
            <legend>Inspiration &amp; Proficiency</legend>
            <label for="inspirationPoints">Inspiration:</label>
            <input type="number" id="inspirationPoints" value="0" min="0">
            <label for="proficiencyBonus">Proficiency Bonus:</label>
            <input type="number" id="proficiencyBonus" value="2" min="0">
          </fieldset>
        </section>
        <!-- Saving Throws Section -->
        <section id="saving-throws">
  <fieldset>
    <legend>Saving Throws</legend>
    <table>
      <tr>
        <th>Ability</th>
        <th>Proficient?</th>
        <th>Modifier</th>
      </tr>
      <tr>
        <td>Strength (STR)</td>
        <td><input type="checkbox" id="strSaveProf" onchange="recalc()"></td>
        <td><input type="text" id="strSave" readonly></td>
      </tr>
      <tr>
        <td>Dexterity (DEX)</td>
        <td><input type="checkbox" id="dexSaveProf" onchange="recalc()"></td>
        <td><input type="text" id="dexSave" readonly></td>
      </tr>
      <tr>
        <td>Constitution (CON)</td>
        <td><input type="checkbox" id="conSaveProf" onchange="recalc()"></td>
        <td><input type="text" id="conSave" readonly></td>
      </tr>
      <tr>
        <td>Intelligence (INT)</td>
        <td><input type="checkbox" id="intSaveProf" onchange="recalc()"></td>
        <td><input type="text" id="intSave" readonly></td>
      </tr>
      <tr>
        <td>Wisdom (WIS)</td>
        <td><input type="checkbox" id="wisSaveProf" onchange="recalc()"></td>
        <td><input type="text" id="wisSave" readonly></td>
      </tr>
      <tr>
        <td>Charisma (CHA)</td>
        <td><input type="checkbox" id="chaSaveProf" onchange="recalc()"></td>
        <td><input type="text" id="chaSave" readonly></td>
      </tr>
    </table>
  </fieldset>
</section>
        <div class="section-grid">
        <section id="dice-roller">
          <fieldset>
            <legend>Dice Roller</legend>
            <input type="text" id="diceFormula" placeholder="e.g., 2d20+1d6">
            <button type="button" onclick="rollDice(event)">Roll Dice</button>
            <div id="diceResults"></div>
          </fieldset>
        </section>
        </div>
        
        <section id="skills">
          <fieldset>
            <legend>Skills</legend>
            <table>
              <tr>
                <th>Skill</th>
                <th>Proficient?</th>
                <th>Modifier</th>
              </tr>
              <tr>
                <td>Acrobatics (DEX)</td>
                <td><input type="checkbox" id="acrobaticsProf" onchange="recalc()"></td>
                <td><input type="text" id="acrobatics" readonly></td>
              </tr>
              <tr>
                <td>Animal Handling (WIS)</td>
                <td><input type="checkbox" id="animalHandlingProf" onchange="recalc()"></td>
                <td><input type="text" id="animalHandling" readonly></td>
              </tr>
              <tr>
                <td>Arcana (INT)</td>
                <td><input type="checkbox" id="arcanaProf" onchange="recalc()"></td>
                <td><input type="text" id="arcana" readonly></td>
              </tr>
              <tr>
                <td>Athletics (STR)</td>
                <td><input type="checkbox" id="athleticsProf" onchange="recalc()"></td>
                <td><input type="text" id="athletics" readonly></td>
              </tr>
              <tr>
                <td>Deception (CHA)</td>
                <td><input type="checkbox" id="deceptionProf" onchange="recalc()"></td>
                <td><input type="text" id="deception" readonly></td>
              </tr>
              <tr>
                <td>History (INT)</td>
                <td><input type="checkbox" id="historyProf" onchange="recalc()"></td>
                <td><input type="text" id="history" readonly></td>
              </tr>
              <tr>
                <td>Insight (WIS)</td>
                <td><input type="checkbox" id="insightProf" onchange="recalc()"></td>
                <td><input type="text" id="insight" readonly></td>
              </tr>
              <tr>
                <td>Intimidation (CHA)</td>
                <td><input type="checkbox" id="intimidationProf" onchange="recalc()"></td>
                <td><input type="text" id="intimidation" readonly></td>
              </tr>
              <tr>
                <td>Investigation (INT)</td>
                <td><input type="checkbox" id="investigationProf" onchange="recalc()"></td>
                <td><input type="text" id="investigation" readonly></td>
              </tr>
              <tr>
                <td>Medicine (WIS)</td>
                <td><input type="checkbox" id="medicineProf" onchange="recalc()"></td>
                <td><input type="text" id="medicine" readonly></td>
              </tr>
              <tr>
                <td>Nature (INT)</td>
                <td><input type="checkbox" id="natureProf" onchange="recalc()"></td>
                <td><input type="text" id="nature" readonly></td>
              </tr>
              <tr>
                <td>Perception (WIS)</td>
                <td><input type="checkbox" id="perceptionProf" onchange="recalc()"></td>
                <td><input type="text" id="perception" readonly></td>
              </tr>
              <tr>
                <td>Performance (CHA)</td>
                <td><input type="checkbox" id="performanceProf" onchange="recalc()"></td>
                <td><input type="text" id="performance" readonly></td>
              </tr>
              <tr>
                <td>Persuasion (CHA)</td>
                <td><input type="checkbox" id="persuasionProf" onchange="recalc()"></td>
                <td><input type="text" id="persuasion" readonly></td>
              </tr>
              <tr>
                <td>Religion (INT)</td>
                <td><input type="checkbox" id="religionProf" onchange="recalc()"></td>
                <td><input type="text" id="religion" readonly></td>
              </tr>
              <tr>
                <td>Sleight of Hand (DEX)</td>
                <td><input type="checkbox" id="sleightOfHandProf" onchange="recalc()"></td>
                <td><input type="text" id="sleightOfHand" readonly></td>
              </tr>
              <tr>
                <td>Stealth (DEX)</td>
                <td><input type="checkbox" id="stealthProf" onchange="recalc()"></td>
                <td><input type="text" id="stealth" readonly></td>
              </tr>
              <tr>
                <td>Survival (WIS)</td>
                <td><input type="checkbox" id="survivalProf" onchange="recalc()"></td>
                <td><input type="text" id="survival" readonly></td>
              </tr>
            </table>
            <label for="passivePerception">Passive Perception (10 + Perception):</label>
            <input type="text" id="passivePerception" readonly>
          </fieldset>
        </section>
        </div>
        
        <div class="section-grid">
        <section id="other-proficiencies">
          <fieldset>
            <legend>Other Proficiencies &amp; Languages</legend>
            <textarea id="otherProficiencies" placeholder="List tools, languages, etc."></textarea>
          </fieldset>
        </section>
        
        <section id="combat-stats">
          <fieldset>
            <legend>Combat Stats</legend>
            
            <div class="armor-selection">
              <label for="armorSelection">Armor:</label>
              <select id="armorSelection" onchange="updateArmorClass()">
                  <option value="None" data-ac="10">None</option>
              </select>
              
              <label for="shieldSelection">Shield:</label>
              <select id="shieldSelection" onchange="updateArmorClass()">
                  <option value="None" data-ac="0">None</option>
              </select>
            </div>

            <p>Armor Class (AC): <input type="text" id="armorClass" value="10" placeholder="Enter AC" readonly></p>
            
            <label for="initiative">Initiative:</label>
            <input type="text" id="initiative" placeholder="+0" readonly>
            <label for="speed">Speed (ft):</label>
            <input type="number" id="speed" placeholder="30">
            <label for="hitPoints">Hit Points (HP):</label>
            <input type="number" id="hitPoints" placeholder="Enter HP">
            <label for="hitDice">Hit Dice:</label>
            <input type="text" id="hitDice" placeholder="e.g., 1d10">
        <button type="button" onclick="shortRestModal.show()">Short Rest</button>
        <button type="button" onclick="longRestModal.show()">Long Rest</button>

<dialog id="shortRestModal">
  <h3>Short Rest</h3>
  <p>A short rest is a period of downtime, at least 1 hour long...</p>
  <button type="button" onclick="shortRest(); shortRestModal.close();">Spend Hit Dice</button>
  <button type="button" onclick="shortRestModal.close()">Cancel</button>
</dialog>

<dialog id="longRestModal">
  <h3>Long Rest</h3>
  <p>A long rest is a period of extended downtime, at least 8 hours long...</p>
  <button type="button" onclick="longRest(); longRestModal.close();">Perform Long Rest</button>
  <button type="button" onclick="longRestModal.close()">Cancel</button>
</dialog>
            <div>
              <strong>Death Saves:</strong>
              <div>
                <span>Successes:</span>
                <input type="checkbox" id="deathSaveSuccess1">
                <input type="checkbox" id="deathSaveSuccess2">
                <input type="checkbox" id="deathSaveSuccess3">
              </div>
              <div>
                <span>Failures:</span>
                <input type="checkbox" id="deathSaveFailure1">
                <input type="checkbox" id="deathSaveFailure2">
                <input type="checkbox" id="deathSaveFailure3">
              </div>
            </div>
          </fieldset>
        </section>
        </div>
        
        <section id="attacks-spellcasting">
          <fieldset>
            <legend>Attacks &amp; Spellcasting</legend>
            <div>
              <strong>Weapons:</strong>
              <datalist id="weaponsList">
                <!-- Options will be populated by JavaScript -->
              </datalist>
              <table id="weaponsTable">
                <tr>
                  <th>Weapon</th>
                  <th>Attack Bonus</th>
                  <th>Damage</th>
                  <th>Action</th>
                </tr>
               
              </table>
              <button type="button" onclick="addWeaponRow()">Add Weapon</button>
            </div>
            <div>
              <label for="spellcastingAbility">Spellcasting Ability:</label>
              <select id="spellcastingAbility" onchange="recalc()">
                <option value="int">Intelligence (INT)</option>
                <option value="wis">Wisdom (WIS)</option>
                <option value="cha">Charisma (CHA)</option>
              </select>
              <label for="spellSaveDC">Spell Save DC:</label>
              <input type="text" id="spellSaveDC" readonly>
              <label for="spellAttackBonus">Spell Attack Bonus:</label>
              <input type="text" id="spellAttackBonus" readonly>
            </div>
          </fieldset>
        </section>
        
        <section id="spell-console">
          <fieldset>
            <legend>Spell Console</legend>
            <div class="module-tabs" role="tablist">
              <button type="button" class="module-tab active" data-tab-target="#spellSlotsPanel">Spell Slots</button>
              <button type="button" class="module-tab" data-tab-target="#spellManagePanel">Manage Spells</button>
            </div>
            <div class="module-panels">
              <div class="module-panel active" id="spellSlotsPanel">
                <label>Spell Slots:</label>
                <div id="spellSlotsContainer" class="spell-slots-grid">
                  <!-- Dynamic slots will appear here -->
                </div>
              </div>
              <div class="module-panel" id="spellManagePanel">
                <div class="spell-management-container">
                  <div class="search-container">
                    <input type="text" id="spellSearchInput" placeholder="Search spells by name or description..." class="spell-search-input">
                    <button type="button" id="searchSpellsButton" class="search-button">Search</button>
                  </div>
                  <div id="spellSearchResults" class="spell-search-results"></div>
                  <div class="spell-lists-container">
                    <div class="spell-list-section">
                      <h4>Known Spells</h4>
                      <ul id="knownSpellsList" class="spells-list"></ul>
                    </div>
                    <div class="spell-list-section">
                      <h4>Prepared Spells</h4>
                      <ul id="preparedSpellsList" class="spells-list"></ul>
                    </div>
                  </div>
                  <button type="button" id="toggleSpellHandbookBtn" class="handbook-button">Open Spellcasting Handbook</button>
                  <div id="spellHandbookContainer" style="display: none;"></div>
                  <button type="button" class="accordion-button">All Spells</button>
                  <div class="spells-accordion">
                    <div class="accordion-content" style="display: none;">
                      <section id="spell-section">
                        <div id="spell-list">
                          <p>Loading spells...</p>
                        </div>
                      </section>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </fieldset>
        </section>
        
        <section id="equipment">
          <fieldset>
            <legend>Equipment</legend>
            <div class="module-tabs" role="tablist">
              <button type="button" class="module-tab active" data-tab-target="#equipmentInventoryPanel">Inventory</button>
              <button type="button" class="module-tab" data-tab-target="#equipmentHandbookPanel">Handbook</button>
            </div>
            <button type="button" id="toggleHandbookBtn" onclick="toggleHandbook()" class="handbook-button handbook-toggle">Open Equipment Handbook</button>
            <div class="module-panels">
              <div class="module-panel active" id="equipmentInventoryPanel">
                <div class="equipment-controls">
                  <button type="button" onclick="addEquipmentRow()">Add Equipment</button>
                </div>
                
                <div class="equipment-layout">
                  <!-- Left side: Equipment table -->
                  <div class="equipment-table-container">
                    <table id="equipmentTable">
                      <thead>
                        <tr>
                          <th>Item Name</th>
                          <th>Cost</th>
                          <th>Quantity</th>
                          <th>Weight (lbs)</th>
                          <th>Equipped?</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        <!-- Equipment rows will be added here dynamically -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              <div class="module-panel" id="equipmentHandbookPanel">
                <div id="equipmentHandbookContainer" class="equipment-handbook-container">
                  <h3>Equipment Handbook</h3>
                  <div class="handbook-content">
                    <iframe src="equipmentbook.html" class="handbook-iframe"></iframe>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Datalist for equipment suggestions -->
            <datalist id="equipmentList">
              <option value="Abacus | Cost: 2 gp | Weight: 2 lb.">
              <option value="Acid (vial) | Cost: 25 gp | Weight: 1 lb.">
              <option value="Alchemist's fire (flask) | Cost: 50 gp | Weight: 1 lb.">
              <option value="*Ammunition* | Cost:  | Weight: ">
              <option value="Arrows (20) | Cost: 1 gp | Weight: 1 lb.">
              <option value="Amber (gemstone) | Cost: 100 gp | Weight: - lb.">
              <option value="Blowgun needles (50) | Cost: 1 gp | Weight: 1 lb.">
              <option value="Crossbow bolts (20) | Cost: 1 gp | Weight: 1½ lb.">
              <option value="Sling bullets (20) | Cost: 4 cp | Weight: 1½ lb.">
              <option value="Antitoxin (vial) | Cost: 50 gp | Weight: —">
              <option value="*Arcane focus* | Cost:  | Weight: ">
              <option value="Crystal | Cost: 10 gp | Weight: 1 lb.">
              <option value="Orb | Cost: 20 gp | Weight: 3 lb.">
              <option value="Rod | Cost: 10 gp | Weight: 2 lb.">
              <option value="Staff | Cost: 5 gp | Weight: 4 lb.">
              <option value="Wand | Cost: 10 gp | Weight: 1 lb.">
              <option value="Backpack | Cost: 2 gp | Weight: 5 lb.">
              <option value="Ball bearings (bag of 1,000) | Cost: 1 gp | Weight: 2 lb.">
              <option value="Barrel | Cost: 2 gp | Weight: 70 lb.">
              <option value="Basket | Cost: 4 sp | Weight: 2 lb.">
              <option value="Bedroll | Cost: 1 gp | Weight: 7 lb.">
              <option value="Bell | Cost: 1 gp | Weight: —">
              <option value="Blanket | Cost: 5 gp | Weight: 3 lb.">
              <option value="Block and tackle | Cost: 1 gp | Weight: 5 lb.">
              <option value="Book | Cost: 25 gp | Weight: 5 lb.">
              <option value="Bottle, glass | Cost: 2 gp | Weight: 2 lb.">
              <option value="Bucket | Cost: 5 cp | Weight: 2 lb.">
              <option value="Caltrops (bag of 20) | Cost: 1 gp | Weight: 2 lb.">
              <option value="Candle | Cost: 1 cp | Weight: —">
              <option value="Case, crossbow bolt | Cost: 1 gp | Weight: 1 lb.">
              <option value="Case, map or scroll | Cost: 1 gp | Weight: 1 lb.">
              <option value="Chain (10 feet) | Cost: 5 gp | Weight: 10 lb.">
              <option value="Chalk (1 piece) | Cost: 1 cp | Weight: —">
              <option value="Chest | Cost: 5 gp | Weight: 25 lb.">
              <option value="Climber's kit | Cost: 25 gp | Weight: 12 lb.">
              <option value="Clothes, common | Cost: 5 sp | Weight: 3 lb.">
              <option value="Clothes, costume | Cost: 5 gp | Weight: 4 lb.">
              <option value="Clothes, fine | Cost: 15 gp | Weight: 6 lb.">
              <option value="Clothes, traveler's | Cost: 2 gp | Weight: 4 lb.">
              <option value="Component pouch | Cost: 25 gp | Weight: 2 lb.">
              <option value="Crowbar | Cost: 2 gp | Weight: 5 lb.">
              <option value="*Druidic focus* | Cost:  | Weight: ">
              <option value="Sprig of mistletoe | Cost: 1 gp | Weight: —">
              <option value="Totem | Cost: 1 gp | Weight: —">
              <option value="Wooden staff | Cost: 5 gp | Weight: 10 lb.">
              <option value="Yew wand | Cost: 5 gp | Weight: 3 lb.">
              <option value="Fishing tackle | Cost: 1 gp | Weight: —">
              <option value="Flask or tankard | Cost: 2 cp | Weight: 1 lb.">
              <option value="Grappling hook | Cost: 2 gp | Weight: —">
              <option value="Hammer | Cost: 1 gp | Weight: 25 lb.">
              <option value="Hammer, sledge | Cost: 2 gp | Weight: 7 lb.">
              <option value="Healer's kit | Cost: 5 gp | Weight: 2 lb.">
              <option value="*Holy symbol* | Cost:  | Weight: ">
              <option value="Amulet | Cost: 1 sp | Weight: —">
              <option value="Emblem | Cost: 5 sp | Weight: —">
              <option value="Reliquary | Cost: 10 gp | Weight: —">
              <option value="Holy water (flask) | Cost: 5 gp | Weight: —">
              <option value="Hourglass | Cost: 5 gp | Weight: —">
              <option value="Hunting trap | Cost: 5 gp | Weight: 25 lb.">
              <option value="Ink (1 ounce bottle) | Cost: 2 gp | Weight: 1 lb.">
              <option value="Ink pen | Cost: 5 cp | Weight: —">
              <option value="Jug or pitcher | Cost: 100 gp | Weight: 1 lb.">
              <option value="Ladder (10-foot) | Cost: 5 cp | Weight: 5 lb.">
              <option value="Lamp | Cost: 2 gp | Weight: 2 lb.">
              <option value="Lantern, bullseye | Cost: 5 sp | Weight: 5 lb.">
              <option value="Lantern, hooded | Cost: 10 gp | Weight: 10 lb.">
              <option value="Lock | Cost: 1 gp | Weight: 2 lb.">
              <option value="Magnifying glass | Cost: 4 gp | Weight: —">
              <option value="Manacles | Cost: 5 sp | Weight: —">
              <option value="Mess kit | Cost: 10 gp | Weight: 4 lb.">
              <option value="Mirror, steel | Cost: 1 cp | Weight: 1/4 lb.">
              <option value="Oil (flask) | Cost: 5 gp | Weight: —">
              <option value="Paper (one sheet) | Cost: 5 sp | Weight: —">
              <option value="Parchment (one sheet) | Cost: 1 gp | Weight: —">
              <option value="Perfume (vial) | Cost: 1 cp | Weight: —">
              <option value="Pick, miner's | Cost: 5 gp | Weight: —">
              <option value="Piton | Cost: 5 sp | Weight: —">
              <option value="Poison, basic (vial) | Cost: 10 gp | Weight: —">
              <option value="Pole (10-foot) | Cost: 5 gp | Weight: —">
              <option value="Pot, iron | Cost: 10 gp | Weight: —">
              <option value="Potion of healing  | Cost: 50 gp | Weight: 1/4 lb.">
              <option value="Pouch | Cost: 2 gp | Weight: —">
              <option value="Quiver | Cost: 5 sp | Weight: —">
              <option value="Ram, portable | Cost: 1 cp | Weight: —">
              <option value="Rations (1 day) | Cost: 5 gp | Weight: —">
              <option value="Robes | Cost: 5 sp | Weight: —">
              <option value="Rope, hempen (50 feet) | Cost: 2 gp | Weight: —">
              <option value="Rope, silk (50 feet) | Cost: 5 cp | Weight: —">
              <option value="Sack | Cost: 2 gp | Weight: —">
              <option value="Scale, merchant's | Cost: 0 gp | Weight: 3">
              <option value="Sealing wax | Cost: 5 sp | Weight: —">
              <option value="Shovel | Cost: 1 gp | Weight: —">
              <option value="Signal whistle | Cost: 4 gp | Weight: —">
              <option value="Signet ring | Cost: 5 sp | Weight: —">
              <option value="Soap | Cost: 1 gp | Weight: —">
              <option value="Spellbook | Cost: 1 gp | Weight: —">
              <option value="Spikes, iron (10) | Cost: 1 cp | Weight: —">
              <option value="Spyglass | Cost: 5 gp | Weight: —">
              <option value="Tent, two-person | Cost: 5 sp | Weight: —">
              <option value="Tinderbox | Cost: 2 gp | Weight: —">
              <option value="Torch | Cost: 5 cp | Weight: —">
              <option value="Vial | Cost: 1 gp | Weight: —">
              <option value="Waterskin | Cost: 2 sp | Weight: —">
              <option value="Whetstone | Cost: 1 cp | Weight: —">
            </datalist>
          </fieldset>
  
          <!-- Inline context area -->
          <div id="equipmentContext" class="context-modal" style="display: none; border: 1px solid #ccc; padding: 10px; margin-top: 10px;">
            <div class="context-content">
              <span class="close-context" onclick="hideEquipmentContext()" style="cursor: pointer;">&times;</span>
              <h3>Item Details</h3>
              <div id="equipmentContextText"></div>
            </div>
          </div>
          <div id="equipmentContext" style="display: none; position: absolute; z-index: 1000; background: white; border: 1px solid #ccc; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
            <div id="equipmentContextText"></div>
          </div>
        
        </section>
        
        
        <section id="feats">
          <fieldset>
            <legend>Feats</legend>
            
            <!-- Feat selection dropdown -->
            <label for="featSelection">Select a Feat:</label>
            <select id="featSelection">
              <option value="">-- Select a Feat --</option>
              <!-- Options dynamically populated -->
            </select>
            
            <!-- Button to add multiple feats -->
            <button type="button" onclick="addFeat()">Add Feat</button>
        
            <!-- Container for displaying the feats the user has selected -->
            <div id="selectedFeatsContainer">
              <!-- We'll render a list of chosen feats here -->
            </div>
            
            <!-- (Optional) single-feat preview, if you still want it -->
            <div id="featDetails"></div>
          </fieldset>
        </section>
        
        <section id="personality-backstory">
          <fieldset>
            <legend>Personality & Bio</legend>
            <label for="physicalTraits">Physical Features:</label>
            <textarea id="physicalTraits" placeholder="Describe physical traits"></textarea>
            <label for="personalityTraits">Personality Traits, Ideals, Bonds, Flaws:</label>
            <textarea id="personalityTraits" placeholder="Describe personality traits"></textarea>
            <label for="backstory">Backstory & Allies/Organizations:</label>
            <textarea id="backstory" placeholder="Describe your character's history and connections"></textarea>
            <label for="featuresTraits">Notes:</label>
            <textarea id="featuresTraits"></textarea>
          </fieldset>
        </section>

        <section id="mr-mappy">
          <fieldset>
            <legend>Mr. Mappy: Map Generator</legend>
            <label class="mappy-toggle checkbox-label">
              <span>Show Advanced Options</span>
              <input type="checkbox" id="toggle-controls">
            </label>
            <div class="mappy-app">
              <div class="mappy-header">
               
              </div>
              <div id="controls" class="mappy-advanced-options">
                <label for="mapSize">Map Size:</label>
                <input type="number" id="mapSize" min="10" max="50" value="20">

                <label for="numTrails">Number of Trails:</label>
                <input type="number" id="numTrails" min="0" max="5" value="1">

                <label for="minTrailLength">Min Trail Length:</label>
                <input type="number" id="minTrailLength" min="0" max="20" value="20">

                <label for="maxTrailLength">Max Trail Length:</label>
                <input type="number" id="maxTrailLength" min="0" max="20" value="20">

                <label for="seed">Seed (optional):</label>
                <input type="text" id="seed" placeholder="e.g., 12345">

                <label class="checkbox-label">
                  <input type="checkbox" id="smoothToggle" checked> Smooth biomes
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" id="contourToggle"> Show contours (elevation)
                </label>
              </div>

              <div id="terrain-probabilities" class="mappy-probabilities"></div>

              <div class="map-and-buttons">
                <div class="mappy-map-stack">
                  <div id="map-container"></div>
                  <canvas id="viewport" width="640" height="640" style="border:1px solid #333; background:#222"></canvas>
                </div>
                <div class="btn-group">
                  <label for="presetSelect">Preset:</label>
                  <select id="presetSelect">
                    <option value="default" selected>Default</option>
                    <option value="island">Island</option>
                    <option value="mountain_caves">Mountain Caves</option>
                    <option value="village">Village</option>
                    <option value="old_ruins">Old Ruins</option>
                    <option value="archipelago">Archipelago</option>
                    <option value="riverlands">Riverlands</option>
                    <option value="jungle">Jungle</option>
                  </select>
                  <button type="button" id="generatePresetBtn">Generate Preset</button>
                  <button type="button" id="generateMapBtn">Generate New Map</button>
                  <button type="button" id="saveMapBtn">Save Map</button>
                  <button type="button" id="loadMapBtn">Load Map</button>
                  <button type="button" id="downloadMapBtn">Download Map as PNG</button>
                  <button type="button" id="undoMapBtn">Undo</button>
                  <button type="button" id="redoMapBtn">Redo</button>
                  <button type="button" class="handbook-button dm-only" id="openPlayerViewBtn">Open Player View</button>
                  <label class="checkbox-label">
                    <input type="checkbox" id="toggle-multi-select"> Multi-Select Mode
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" id="readOnlyToggle"> Read-only View
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" id="measureToggle"> Measure Tool
                  </label>
                  <label class="checkbox-label">
                    <input type="checkbox" id="labelToggle"> Label Mode
                  </label>
                  <button type="button" id="clearLabelsBtn">Clear Labels</button>
                  <label class="checkbox-label">
                    <input type="checkbox" id="fogToggle"> Fog of War
                  </label>
                  <div id="fogControls" class="mappy-fog-controls">
                    <label class="checkbox-label"><input type="checkbox" id="fogEditToggle"> Fog Edit Mode</label>
                    <div>
                      <label><input type="radio" name="fogMode" value="reveal" checked> Reveal</label>
                      <label><input type="radio" name="fogMode" value="hide"> Hide</label>
                    </div>
                    <div>
                      <label>Brush Size: <input type="range" id="fogBrush" min="1" max="5" value="2"></label>
                    </div>
                    <button type="button" id="clearFogBtn">Clear Fog</button>
                  </div>
                  <label for="terrainDropdown">Change Selected Tiles to:</label>
                  <select id="terrainDropdown">
                    <option value="">Select terrain</option>
                  </select>
                </div>
              </div>

              <canvas id="mapCanvas" style="display: none;"></canvas>
              <canvas id="minimap" width="510" height="510" style="border:1px solid #999; margin-top:10px;"></canvas>
              <div id="legend"></div>
            </div>
          </fieldset>
        </section>
      </div>
      </form>
      <div class="hud-bar dm-only">
        <div class="hud-item">
          <span>HP</span>
          <strong id="hudHP">0</strong>
        </div>
        <div class="hud-item">
          <span>AC</span>
          <strong id="hudAC">0</strong>
        </div>
        <div class="hud-item">
          <span>Speed</span>
          <strong id="hudSpeed">0</strong>
        </div>
        <div class="hud-item">
          <span>Inspiration</span>
          <strong id="hudInspiration">0</strong>
        </div>
        <button type="button" class="hud-action" data-scroll-target="#attacks-spellcasting">Combat</button>
        <button type="button" class="hud-action" data-scroll-target="#spell-console">Spells</button>
        <button type="button" class="hud-action" data-scroll-target="#equipment">Gear</button>
        <button type="button" class="hud-action" data-scroll-target="#mr-mappy">Map</button>
      </div>
      </div>
    </main>
  </div>
   <footer>
    <p>&copy; D&D Character Manager by BRENDEN DAVIS, 2025. All rights reserved. <a href="https://brendendavis.com" target="_blank">Web Design by Brenden Davis</a></p>
  </footer>
  
  <script>
    
    // Accordion for spell management
    document.addEventListener("DOMContentLoaded", function() {
  const allSpellsButton = document.querySelector(".accordion-button");
  const spellPanel = document.querySelector(".accordion-content");

  if (allSpellsButton && spellPanel) {
    allSpellsButton.addEventListener("click", function(event) {
      event.preventDefault();
      this.classList.toggle("active");
      spellPanel.style.display = (spellPanel.style.display === "block") ? "none" : "block";
    });
  }

  const toggleBtn = document.getElementById("sidebarToggle");
  if (toggleBtn) {
    toggleBtn.addEventListener("click", () => {
      document.body.classList.toggle("sidebar-open");
    });
  }
  const closeSidebar = () => document.body.classList.remove("sidebar-open");
  function scrollSectionIntoView(selector, contextDoc = document) {
    if (!selector) return false;
    const target = contextDoc.querySelector(selector);
    if (!target) return false;
    target.scrollIntoView({ behavior: "smooth", block: "start" });
    target.classList.remove("pulse-highlight");
    const view = contextDoc.defaultView || window;
    const raf = view.requestAnimationFrame || window.requestAnimationFrame;
    if (typeof raf === "function") {
      raf(() => target.classList.add("pulse-highlight"));
    } else {
      target.classList.add("pulse-highlight");
    }
    const timeoutFn = view.setTimeout || window.setTimeout;
    timeoutFn(() => target.classList.remove("pulse-highlight"), 800);
    return true;
  }
  document.querySelectorAll(".sidebar a").forEach(link => {
    link.addEventListener("click", closeSidebar);
    const href = link.getAttribute("href") || "";
    if (!href.startsWith("#")) return;
    link.addEventListener("click", (event) => {
      const selector = href;
      const activePanel = document.querySelector(".profile-panel.active");
      if (activePanel && activePanel.dataset.profileId !== "dm") {
        const frame = activePanel.querySelector("iframe");
        const frameDoc = frame?.contentDocument;
        if (frameDoc && scrollSectionIntoView(selector, frameDoc)) {
          event.preventDefault();
          return;
        }
      }
      if (scrollSectionIntoView(selector, document)) {
        event.preventDefault();
      }
    });
  });
  document.addEventListener("keydown", (event) => {
    if (event.key === "Escape") {
      document.body.classList.remove("sidebar-open");
    }
  });
  const glanceBindings = [
    { input: "characterName", output: "glanceName", fallback: "Unnamed Hero" },
    { input: "level", output: "glanceLevel", fallback: "1" },
    { input: "hitPoints", output: "glanceHP", fallback: "0" },
    { input: "inspirationPoints", output: "glanceInspiration", fallback: "0" }
  ];
  glanceBindings.forEach(({ input, output, fallback }) => {
    const inputEl = document.getElementById(input);
    const outputEl = document.getElementById(output);
    if (!inputEl || !outputEl) return;
    const handler = () => {
      const value = inputEl.value?.trim();
      outputEl.textContent = value ? value : fallback;
    };
    handler();
    inputEl.addEventListener("input", handler);
    inputEl.addEventListener("change", handler);
  });
  const hudBindings = [
    { input: "hitPoints", output: "hudHP", fallback: "0" },
    { input: "armorClass", output: "hudAC", fallback: "0" },
    { input: "speed", output: "hudSpeed", fallback: "0" },
    { input: "inspirationPoints", output: "hudInspiration", fallback: "0" }
  ];
  hudBindings.forEach(({ input, output, fallback }) => {
    const source = document.getElementById(input);
    const target = document.getElementById(output);
    if (!source || !target) return;
    const handler = () => {
      const value = source.value?.trim();
      target.textContent = value ? value : fallback;
    };
    handler();
    source.addEventListener("input", handler);
    source.addEventListener("change", handler);
  });
  document.querySelectorAll("[data-scroll-target]").forEach(button => {
    button.addEventListener("click", () => {
      const selector = button.dataset.scrollTarget;
      scrollSectionIntoView(selector, document);
    });
  });
  document.querySelectorAll(".module-tabs").forEach(tabGroup => {
    const tabs = tabGroup.querySelectorAll(".module-tab");
    const panelsWrapper = tabGroup.parentElement.querySelector(".module-panels");
    tabs.forEach(tab => {
      tab.addEventListener("click", () => {
        const targetSelector = tab.dataset.tabTarget;
        if (!targetSelector) return;
        tabs.forEach(btn => btn.classList.remove("active"));
        tab.classList.add("active");
        if (panelsWrapper) {
          panelsWrapper.querySelectorAll(".module-panel").forEach(panel => panel.classList.remove("active"));
        }
        const panel = document.querySelector(targetSelector);
        panel?.classList.add("active");
        const toggleBtn = document.getElementById("toggleHandbookBtn");
        if (toggleBtn) {
          if (targetSelector === "#equipmentHandbookPanel") {
            toggleBtn.textContent = "Back to Inventory";
          } else if (targetSelector === "#equipmentInventoryPanel") {
            toggleBtn.textContent = "Open Equipment Handbook";
          }
        }
      });
    });
  });
});




  </script>
  <datalist id="weaponsList">
    <!-- Options will be populated by JavaScript -->
  </datalist>
  <div>
    <!-- Additional buttons for save/load character can be added here if desired -->
  </div>
  <script src="charsaves.js"></script>
  <script src="script.js"></script>
  <script src="classActions.js"></script>
  <script src="spellManagement.js"></script>
  <script src="feats.js"></script>
  <script src="rests.js"></script>
  <script>
    (function() {
      if (window.IS_EMBEDDED_VIEW) return;
      document.addEventListener('DOMContentLoaded', () => {
        const tabsContainer = document.querySelector('.profile-tabs');
        const dmWorkspace = document.getElementById('dmWorkspace');
        if (!tabsContainer || !dmWorkspace) return;
        const addButton = document.getElementById('addPlayerTab');
        const panelContainer = document.createElement('div');
        panelContainer.className = 'profile-panels';
        const dmPanel = document.createElement('section');
        dmPanel.className = 'profile-panel active';
        dmPanel.dataset.profileId = 'dm';
        dmWorkspace.parentNode.insertBefore(panelContainer, dmWorkspace);
        panelContainer.appendChild(dmPanel);
        dmPanel.appendChild(dmWorkspace);

        let playerCount = tabsContainer.querySelectorAll('.profile-tab[data-role="player"]').length || 0;

        function createPlayerPanel(profileId, label) {
          const panel = document.createElement('section');
          panel.className = 'profile-panel';
          panel.dataset.profileId = profileId;
          const frame = document.createElement('iframe');
          frame.className = 'player-iframe';
          frame.title = `${label} Character Workspace`;
          const params = new URLSearchParams();
          params.set('view', 'player');
          params.set('profile', profileId);
          params.set('embedded', 'true');
          if (window.CAMPAIGN_ID) {
            params.set('campaign', window.CAMPAIGN_ID);
          }
          frame.src = `index.html?${params.toString()}`;
          panel.appendChild(frame);
          panelContainer.appendChild(panel);
        }

        function setActiveTab(profileId) {
          if (!profileId) return;
          tabsContainer.querySelectorAll('.profile-tab').forEach(tab => {
            if (tab.id === 'addPlayerTab') return;
            tab.classList.toggle('active', tab.dataset.profileId === profileId);
          });
          panelContainer.querySelectorAll('.profile-panel').forEach(panel => {
            panel.classList.toggle('active', panel.dataset.profileId === profileId);
          });
        }

        tabsContainer.addEventListener('click', (event) => {
          const tab = event.target.closest('.profile-tab');
          if (!tab || tab.id === 'addPlayerTab') return;
          setActiveTab(tab.dataset.profileId);
        });

        if (addButton) {
          addButton.addEventListener('click', () => {
            playerCount += 1;
            const profileId = `player-${playerCount}`;
            const tab = document.createElement('button');
            tab.type = 'button';
            tab.className = 'profile-tab';
            tab.dataset.profileId = profileId;
            tab.dataset.role = 'player';
            tab.textContent = `Player ${playerCount}`;
            tabsContainer.insertBefore(tab, addButton);
            createPlayerPanel(profileId, `Player ${playerCount}`);
            setActiveTab(profileId);
          });
        }

        tabsContainer.querySelectorAll('.profile-tab').forEach(tab => {
          const role = tab.dataset.role || 'player';
          const profileId = tab.dataset.profileId;
          if (profileId === 'dm') return;
          createPlayerPanel(profileId, tab.textContent.trim());
        });

        setActiveTab('dm');
      });
    })();
  </script>
  <script>
    (function() {
      const section = document.getElementById('mr-mappy');
      if (!section) return;
      let loaded = false;
      const loadMappyScript = () => {
        if (loaded) return;
        loaded = true;
        const script = document.createElement('script');
        script.src = 'mappy.js';
        script.defer = true;
        document.head.appendChild(script);
      };

      const observerSupported = 'IntersectionObserver' in window;
      if (observerSupported) {
        const observer = new IntersectionObserver(entries => {
          if (entries.some(entry => entry.isIntersecting)) {
            loadMappyScript();
            observer.disconnect();
          }
        }, { rootMargin: '200px' });
        observer.observe(section);
      } else {
        loadMappyScript();
      }

      section.addEventListener('click', loadMappyScript, { once: true });
      const advToggle = document.getElementById('toggle-controls');
      advToggle?.addEventListener('focus', loadMappyScript, { once: true });
    })();
  </script>
  <script>
    window.FIREBASE_CONFIG = window.FIREBASE_CONFIG || {
      apiKey: "AIzaSyAMLwvHKhkTpEjipGyqTlh83WKjVQWU9fs",
      authDomain: "dndmanager-bd67.firebaseapp.com",
      projectId: "dndmanager-bd67",
     
      storageBucket: "dndmanager-bd67.firebasestorage.app",
      messagingSenderId: "443148232086",
      appId: "1:443148232086:web:77305736218ec4a105e9b7",
    };
  </script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script>
    (function() {
      if (!window.FIREBASE_CONFIG || !window.FIREBASE_CONFIG.apiKey) {
        console.warn('Firebase config missing. Remote map sync is disabled.');
        return;
      }
      try {
        if (!window.firebase?.apps?.length) {
          firebase.initializeApp(window.FIREBASE_CONFIG);
        }
        window.firebaseDB = firebase.firestore();
      } catch (err) {
        console.warn('Failed to initialize Firebase', err);
      }
    })();
  </script>
  <!-- Add HTML2PDF library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</body>
</html>
